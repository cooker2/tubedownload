<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>VideoMAX - YouTube Downloader</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    body { background-color: #0d0437; }
    .custom-header { background-color: #0d0437; }
  </style>
  <script>
    document.cookie = "user_id=debug_user; path=/";

    function extractVideoId(url) {
      try {
        const parsed = new URL(url);
        let id = parsed.searchParams.get("v");
        if (id) return id;
        const match = url.match(/(?:v=|\/)([0-9A-Za-z_-]{11})(?:&|$)/);
        return match ? match[1] : "";
      } catch (e) {
        console.error("æå– videoId å¤±è´¥:", e);
        return "";
      }
    }
  </script>
</head>

<body class="text-white font-sans">
  <section class="custom-header text-center py-16 px-4">
    <h1 class="text-4xl md:text-5xl font-bold mb-4">
      Online Video <span class="text-[#e11d48]">Downloader</span>
    </h1>
    <p class="text-gray-300 mb-8 max-w-xl mx-auto">
      Paste the YouTube link below & click
    </p>
    <div class="flex justify-center gap-2 flex-wrap">
      <input id="url" type="text" placeholder="Paste YouTube Video Link Here..." 
        class="w-80 md:w-[500px] px-4 py-3 rounded-full text-black" />
      <button onclick="document.getElementById('url').blur(); fetchFormats()" 
        class="px-6 py-3 bg-[#e11d48] hover:bg-[#be123c] text-white rounded-full font-semibold shadow transition duration-300">
        Download
      </button>
    </div>
  </section>

  <section class="text-center py-10">
    <div id="status" class="text-yellow-400 mb-2"></div>
    <div id="video-info" class="space-y-4"></div>
    <div id="task-result" class="text-yellow-400 font-semibold"></div>

    <div id="download-status" class="hidden">
      <div class="w-full max-w-md mx-auto mt-6">
        <div class="text-center mb-2 text-white" id="progress-text">0%</div>
        <div class="bg-gray-700 rounded h-6 w-full">
          <div id="new-progress-bar" 
            class="bg-green-500 h-full rounded text-xs text-center text-white leading-6" 
            style="width: 0%">0%</div>
        </div>
      </div>
    </div>
  </section>

  <script>


async function fetchFormats() {
  const url = document.getElementById("url").value;
  document.getElementById("status").innerText = "â³ Parsing video...";
  document.getElementById("video-info").innerHTML = "";
  document.getElementById("task-result").innerText = "";
  document.getElementById("download-status").classList.add("hidden");

  try {
    const res = await fetch("/fetch_formats", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ url })
    });
    const data = await res.json();

    if (data.status === "success") {
      // è¿‡æ»¤ã€åˆ†ç»„é€»è¾‘ä¸å˜
      const wantedNotes = ["240p","360p","720p","1080p","1440p","2160p"];
      const candidates = data.formats.filter(f => {
        const note = (f.format_note || "").toLowerCase();
        return wantedNotes.some(w => note.includes(w)) && ["mp4","webm"].includes(f.ext);
      });
      const grouped = {};
      for (const f of candidates) {
        const key = (f.format_note || `${f.height}p`).toLowerCase();
        if (!grouped[key] || (f.filesize||0) > (grouped[key].filesize||0)) {
          grouped[key] = f;
        }
      }
      const finalFormats = Object.values(grouped);

      // ç”Ÿæˆï¼šå·¦ä¾§åˆ†è¾¨ç‡+å¤§å°ï¼Œå³ä¾§ Download æŒ‰é’®
  const formatsHtml = finalFormats.map(f => {
    const note = f.format_note || `${f.height}p`;
    const sizeMB = f.filesize
      ? (f.filesize / (1024 * 1024)).toFixed(1)
      : 0;
    const sizeText = f.filesize
      ? `${sizeMB}MB`
      : "æœªçŸ¥å¤§å°";

    const isTooBig = sizeMB > 200;

    const buttonHtml = isTooBig
      ? `<button disabled class="ml-4 px-4 py-2 bg-gray-600 rounded text-white text-sm cursor-not-allowed">
            è¶…å‡ºå¤§å°é™åˆ¶
         </button>`
      : `<button
            onclick="queueDownload('${url}','${f.format_id}')"
            class="ml-4 px-4 py-2 bg-[#e11d48] hover:bg-[#be123c] rounded text-white text-sm">
            Download
         </button>`;

    return `
        <div class="flex justify-between items-center w-full max-w-md px-4 py-2 bg-gray-800 rounded">
          <div class="flex-1 text-left text-white">
            ${note} Â· ${sizeText}
          </div>
          ${buttonHtml}
        </div>
    `;
}).join("");

      const fullTitle = data.title || "";
      const displayTitle = fullTitle.length > 20
        ? fullTitle.slice(0,20) + "â€¦"
        : fullTitle;

      document.getElementById("status").innerText = "";
      document.getElementById("video-info").innerHTML = `
        <img src="${data.thumbnail}" class="mx-auto rounded-lg shadow-lg max-w-xs" />
        <div class="text-xl mt-2 mx-auto max-w-[80%] truncate" title="${data.title}">
          ${displayTitle}
        </div>
        <p class="text-sm text-gray-400">Duration: ${data.duration}</p>
        <div class="flex flex-col items-center gap-3 mt-4">
          ${formatsHtml}
        </div>
      `;
    } else {
      document.getElementById("status").innerText = "âŒ Failed to parse: " + data.message;
    }
  } catch (err) {
    console.error("è§£æå¼‚å¸¸:", err);
    document.getElementById("status").innerText = "âŒ Request failed. Please check the URL.";
  }
}


async function queueDownload(url, format_id) {
  
  const progressBar = document.getElementById("new-progress-bar");
  const progressText = document.getElementById("progress-text");
  progressBar.style.width = "0%";
  progressBar.innerText = "0%";
  progressText.innerText = "0%";

  document.getElementById("task-result").innerText = "ğŸ“¥ Submitting download task...";
  document.getElementById("download-status").classList.remove("hidden");
  try {
    const res = await fetch(`/queue_download?url=${encodeURIComponent(url)}&format_id=${format_id}`);
    const data = await res.json();

    if (data.status === "queued") {
      document.getElementById("task-result").innerText = "âœ… Task added to queue";
      document.getElementById("download-status").classList.remove("hidden");
      checkDownloadStatus(url, format_id);
    } else if (data.status === "done" && data.download_url) {
      document.getElementById("task-result").innerHTML = `
        <div class="text-green-400 font-bold">âœ… Already downloaded.</div>
        <a href="${data.download_url}" target="_blank" class="mt-4 inline-block px-6 py-2 bg-blue-500 text-white rounded-full hover:bg-blue-600">Open File</a>
      `;
      document.getElementById("download-status").classList.remove("hidden");
    } else {
      document.getElementById("task-result").innerText = "âš ï¸ " + (data.message || "Unknown error.");
    }
  } catch (err) {
    document.getElementById("task-result").innerText = "âŒ Download request failed.";
  }
}

    
async function checkDownloadStatus(url, format_id) {
  const videoId = extractVideoId(url);
  const progressBar = document.getElementById("new-progress-bar");
  const progressText = document.getElementById("progress-text");
  const statusEl = document.getElementById("task-result");

  function getUserId() {
    const cookies = document.cookie.split(';');
    for (let i = 0; i < cookies.length; i++) {
      const cookie = cookies[i].trim();
      if (cookie.startsWith('user_id=')) {
        return cookie.substring('user_id='.length);
      }
    }
    return 'debug_user'; // é»˜è®¤å€¼
  }

  const userId = getUserId();
  const wsProtocol = location.protocol === "https:" ? "wss" : "ws";
  const wsUrl = `${wsProtocol}://${location.host}/ws/progress?user_id=${userId}&video_id=${videoId}`;
  const socket = new WebSocket(wsUrl);

  console.log(`[WebSocket] Connecting to ${wsUrl}...`);

  socket.onopen = () => {
    console.log("[WebSocket] Connected!");
  };

  socket.onmessage = async (event) => {
  const data = JSON.parse(event.data);

  if (data.status === 'uploaded' && data.download_url) {
    socket.close();

    progressBar.style.width = "100%";
    progressBar.innerText = "100%";
    progressBar.className = "bg-blue-500 h-full rounded text-xs text-center text-white leading-6";

    statusEl.innerHTML = `
      <div class="text-green-400 font-bold">âœ… Download and upload completed!</div>
      <a href="${data.download_url}" target="_blank" class="mt-4 inline-block px-6 py-2 bg-blue-500 text-white rounded-full hover:bg-blue-600">Open File</a>
    `;
    progressText.innerText = "Completed";

  } else if (data.status === 'preparing') {
    progressText.innerText = "Preparing download file, please wait...";
    statusEl.innerHTML = `<div class="text-yellow-400 font-bold">ğŸ“¦ Preparing your download, please wait...</div>`;

  } else if (data.status === 'downloading' && data.percent) {
    // ğŸ”¥ æ–°å¢ï¼šä¸‹è½½ä¸­å®æ—¶æ›´æ–°è¿›åº¦
    const percent = parseFloat(data.percent.replace('%', '')) || 0;
    const displayPercent = `${percent.toFixed(1)}%`;
    progressBar.style.width = displayPercent;
    progressBar.innerText = displayPercent;
    progressText.innerText = `Downloading: ${displayPercent} | Speed: ${data.speed || '-'} | ETA: ${data.eta || '-'}`;
  }
};

  socket.onerror = (err) => {
    console.error("[WebSocket] è¿æ¥é”™è¯¯", err);
  };

  socket.onclose = () => {
    console.log("[WebSocket] è¿æ¥å…³é—­");
  };
}

document.addEventListener('DOMContentLoaded', function() {
  const urlInput = document.getElementById('url');
  urlInput.addEventListener('keydown', function(event) {
    if (event.key === 'Enter') {
      event.preventDefault(); // é˜»æ­¢é»˜è®¤çš„è¡¨å•æäº¤
      urlInput.blur();         // å¤±ç„¦
      fetchFormats();          // æ‰§è¡Œè§£æ
    }
  });
});

  </script>
</body>
</html>
