<!DOCTYPE html>
<html lang="en">
<head>
  <link rel="icon" href="https://www.youtube.com/s/desktop/1fabcff3/img/favicon_144.png" type="image/png">
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>VideoMAX - YouTube Downloader</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    @keyframes flowing-bar {
      0% { background-position: 0% 50%; }
      100% { background-position: 100% 50%; }
    }

    body {
      background-color: #0d0437;
    }

    .custom-header {
      background-color: #0d0437;
    }
  </style>
</head>
<body class="text-white font-sans">

  <!-- Header -->
  <section class="custom-header text-center py-16 px-4">
    <h1 class="text-4xl md:text-5xl font-bold mb-4">Online Video <span class="text-[#e11d48]">Downloader</span></h1>
    <p class="text-gray-300 mb-8 max-w-xl mx-auto">Paste the YouTube link below & click</p>
    <div class="flex justify-center gap-2 flex-wrap">
      <input id="url" type="text" placeholder="Paste YouTube Video Link Here..." class="w-80 md:w-[500px] px-4 py-3 rounded-full text-black" />
      <button onclick="fetchFormats()" class="px-6 py-3 bg-[#e11d48] hover:bg-[#be123c] text-white rounded-full font-semibold shadow transition duration-300">Download</button>
    </div>
  </section>

  <!-- Video Info -->
  <section class="text-center py-10">
    <div id="status" class="text-yellow-400 mb-2"></div>
    <div id="video-info" class="space-y-4"></div>
    <div id="task-result" class="text-yellow-400 font-semibold"></div>
    <div id="progress-bar" class="hidden w-1/3 md:w-1/4 h-4 bg-gray-700 rounded-full mx-auto mt-6 overflow-hidden">
      <div id="progress-fill" class="h-full w-0 text-xs text-black font-bold text-center transition-all duration-300 bg-[length:400%_400%] bg-[linear-gradient(270deg,#00F260,#0575E6)] animate-[flowing-bar_2s_linear_infinite]">
        0%
      </div>
    </div>
  </section>

  <script>
    async function fetchFormats() {
      const oldLink = document.getElementById("download-link");
      if (oldLink) oldLink.remove();
      const url = document.getElementById("url").value;
      document.getElementById("status").innerText = "‚è≥ Parsing video...";
      document.getElementById("video-info").innerHTML = "";
      document.getElementById("task-result").innerText = "";
      document.getElementById("progress-bar").classList.add("hidden");
      document.getElementById("progress-fill").style.width = "0%";

      try {
        const res = await fetch("/fetch_formats", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ url })
        });
        const data = await res.json();
        if (data.status === "success") {
          document.getElementById("status").innerText = "";
          document.getElementById("video-info").innerHTML = `
            <img src="${data.thumbnail}" class="mx-auto rounded-lg shadow-lg max-w-xs" />
            <div class="text-xl font-bold mt-2 mx-auto max-w-[30%] truncate overflow-hidden whitespace-nowrap" title="${data.title}">
              ${data.title}
            </div>

            <p class="text-sm text-gray-400">Duration: ${data.duration}</p>
            <div class="text-lg font-semibold text-yellow-400 mt-4">üé¨ Choose a format to download:</div>
            <div class="flex flex-wrap justify-center gap-2 mt-4">
        ${data.formats.map(f => `
  <button onclick="queueDownload('${url}', '${f.format_id}')" 
          class="px-3 py-2 bg-[#e11d48] hover:bg-[#be123c] rounded text-white text-sm">
    ${f.format_note} (.${f.ext})
  </button>
`).join("")}



            </div>`;
        } else {
          document.getElementById("status").innerText = "‚ùå Failed to parse: " + data.message;
        }
      } catch (err) {
        document.getElementById("status").innerText = "Request failed. Please check the URL format.";
      }
    }

    async function queueDownload(url, format_id) {
      document.getElementById("task-result").innerText = "üì• Submitting download task...";
      try {
        const res = await fetch(`/queue_download?url=${encodeURIComponent(url)}&format_id=${format_id}`);
        const data = await res.json();
        if (data.status === "queued") {
          document.getElementById("task-result").innerText = "‚úÖ Task added to queue";
          document.getElementById("progress-bar").classList.remove("hidden");
          checkDownloadStatus(url, format_id);
        } else {
          document.getElementById("task-result").innerText = "‚ö†Ô∏è " + data.message;
        }
      } catch (err) {
        document.getElementById("task-result").innerText = "‚ùå Download request failed.";
      }
    }

    async function checkDownloadStatus(url, format_id) {
      const resultEl = document.getElementById("task-result");
      const videoId = new URL(url).searchParams.get("v");
      const fillEl = document.getElementById("progress-fill");

      const check = async () => {
        try {
          const statusRes = await fetch(`/status?url=https://youtube.com/watch?v=${videoId}&format_id=${format_id}`);
          const statusData = await statusRes.json();
          if (statusData.status === "done") {
            fillEl.style.width = "100%";
            fillEl.innerText = "100%";
            fillEl.classList.remove("animate-[flowing-bar_2s_linear_infinite]");
            fillEl.style.background = "#d1d5db";
            resultEl.innerHTML = `<span class=text-yellow-400 font-bold text-base mt-10'>‚úÖ Download complete!</span>`;
            const existing = document.getElementById("download-link");
            if (!existing) {
              const downloadLink = document.createElement("a");
downloadLink.id = "download-link";
downloadLink.href = `/downloads/${statusData.filename}`;
downloadLink.innerHTML = "üìÅ <span class='align-middle'>Open file</span>";
downloadLink.target = "_blank";
downloadLink.className =
  "mt-6 inline-block border border-[#e11d48] bg-white text-[#e11d48] text-sm font-semibold py-2 px-6 rounded-full shadow-md hover:bg-[#fef2f2] transition duration-300";
document.getElementById("progress-bar").after(downloadLink);
            }
            clearInterval(timer);
            return;
          }

          if (statusData.status === "downloading") {
            const progressRes = await fetch(`/progress?url=https://youtube.com/watch?v=${videoId}`);
            const progress = await progressRes.json();
            fillEl.style.width = progress.percent;
            fillEl.innerText = progress.percent;
            resultEl.innerHTML = `
              üì• Downloading...<br>
              <span class="text-sm text-yellow-400">
                <b>Speed:</b> ${progress.speed} |
                <b>Size:</b> ${progress.downloaded} / ${progress.total} |
                <b>ETA:</b> ${progress.eta}
              </span>`;
          }
        } catch (err) {
          console.error("Polling error", err);
        }
      };

      await check();
      const timer = setInterval(check, 1000);
    }
  </script>

</body>
</html>
